<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Docker toolbelt</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Raimon Grau" />
<meta name="keywords" content="bash zsh shell" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Docker toolbelt</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org4f00cd8">1. Intro</a></li>
<li><a href="#orgcd88580">2. What do we want?</a></li>
<li><a href="#orgfdc6974">3. When do we want it?</a></li>
<li><a href="#orge5743bc">4. Why do we want it?</a></li>
<li><a href="#orge4ea2e8">5. How are we going to do it?</a></li>
<li><a href="#org93caf93">6. What is a container?</a></li>
<li><a href="#org65210b0">7. ETOOMANYFLAGS</a></li>
<li><a href="#orga041a3f">8. Lifecycle</a></li>
<li><a href="#orgae2ed39">9. What are containers made of?</a></li>
<li><a href="#orgfe45bd0">10. can I run 2 containers on the same filesystem?</a></li>
<li><a href="#org0a5a1c3">11. patterns</a></li>
<li><a href="#org55213e8">12. Build</a></li>
<li><a href="#org2b29b93">13. Dockerfile</a></li>
<li><a href="#org89ac23b">14. images can extend other images</a></li>
<li><a href="#orgb0eddb1">15. can I only "inherit" from an official image?</a></li>
<li><a href="#org90b4071">16. Examples?</a></li>
<li><a href="#org4ab1f78">17. How do we know it?</a></li>
<li><a href="#org700a9c8">18. Let's play with docker inspect</a></li>
<li><a href="#org40aafdc">19. Where/how are those images stored?</a></li>
<li><a href="#orga574635">20. Dockerfiles are like</a></li>
<li><a href="#org90e93f4">21. Running a container</a></li>
<li><a href="#orge0cd257">22. Minimal flags</a></li>
<li><a href="#org6eed0ab">23. testing images and containers</a></li>
<li><a href="#org3930ed4">24. Running multiple commands</a></li>
<li><a href="#org3b30f1f">25. Commit</a></li>
<li><a href="#orgf6a9697">26. Env vars</a></li>
<li><a href="#orgbd643ca">27. If I am a program running on a container, what do I see?</a>
<ul>
<li><a href="#org2e2044d">27.1. Processes</a></li>
<li><a href="#org5a3d4ff">27.2. Network</a></li>
<li><a href="#org72a3b95">27.3. filesystem</a></li>
</ul>
</li>
<li><a href="#org2b37001">28. Can a container run more than one process?</a></li>
<li><a href="#org3a78c28">29. Using cat from ubuntu container</a></li>
<li><a href="#org3994299">30. mount a file and cat it from inside</a></li>
<li><a href="#org0970f02">31. Docker as a tool to help you hack on development</a>
<ul>
<li><a href="#orge80bf6b">31.1. network</a></li>
</ul>
</li>
<li><a href="#org36ad0af">32. dev</a></li>
</ul>
</div>
</div>

<div id="outline-container-org4f00cd8" class="outline-2">
<h2 id="org4f00cd8"><span class="section-number-2">1</span> Intro</h2>
<div class="outline-text-2" id="text-1">
<p>
Hey! In this doc we're going to learn a few things about docker, and
about development environments. Stay tuned.
</p>
</div>
</div>

<div id="outline-container-orgcd88580" class="outline-2">
<h2 id="orgcd88580"><span class="section-number-2">2</span> What do we want?</h2>
<div class="outline-text-2" id="text-2">
<p>
The aim of this doc is to learn about docker and docker compose
through a practical project. This project is a development
environment generator. Which I'll be building with you as we go.
</p>
</div>
</div>

<div id="outline-container-orgfdc6974" class="outline-2">
<h2 id="orgfdc6974"><span class="section-number-2">3</span> When do we want it?</h2>
<div class="outline-text-2" id="text-3">
<p>
ASAP
</p>
</div>
</div>

<div id="outline-container-orge5743bc" class="outline-2">
<h2 id="orge5743bc"><span class="section-number-2">4</span> Why do we want it?</h2>
<div class="outline-text-2" id="text-4">
<p>
To have awesome pipelines, development environments, and to learn
about containers.
</p>
</div>
</div>

<div id="outline-container-orge4ea2e8" class="outline-2">
<h2 id="orge4ea2e8"><span class="section-number-2">5</span> How are we going to do it?</h2>
<div class="outline-text-2" id="text-5">
<p>
At first, it's going to be about docker. Then we'll use
docker-compose, and finally we'll generate docker-compose files
automatically, like there's no tomorrow.
</p>
</div>
</div>

<div id="outline-container-org93caf93" class="outline-2">
<h2 id="org93caf93"><span class="section-number-2">6</span> What is a container?</h2>
<div class="outline-text-2" id="text-6">
<p>
Do you know chroot? ok, imagine you create a chroot and you run a
something inside it. You are going to run it successfully, and
that process is only going to have access to that part of the
filesystem.  But, the process you're running, will it be able
to see other processes? what would <code>htop</code> say? Also, what about
<code>ping www.google.com</code>?
</p>

<p>
Containers is how we name cgroups and networking and lxc working
together to isolate processes from other processes, or group them
together.
</p>
</div>
</div>

<div id="outline-container-org65210b0" class="outline-2">
<h2 id="org65210b0"><span class="section-number-2">7</span> ETOOMANYFLAGS</h2>
<div class="outline-text-2" id="text-7">
<p>
we'll use <code>docker</code>. All container systems have too many
flags. There's a lot of things they can tune, but the amount of
flags is scary. There's no way around it.
</p>
</div>
</div>

<div id="outline-container-orga041a3f" class="outline-2">
<h2 id="orga041a3f"><span class="section-number-2">8</span> Lifecycle</h2>
<div class="outline-text-2" id="text-8">
<p>
The same as virtual machines, there are several states in which it can be.
<a href="https://medium.com/@BeNitinAgarwal/lifecycle-of-docker-container-d2da9f85959">https://medium.com/@BeNitinAgarwal/lifecycle-of-docker-container-d2da9f85959</a>
</p>

<p>
The difference with VMS is that usually, you start a VM, and it will
run some default processes (init, or system32-something, or
explore.exe). Containers, on the other side, are usually alive only
while they run the main process you started them with.
</p>

<p>
A single container can run multiple processes, but in general, we're
advised to start containers with a single main process, and when the
process dies, the container should follow suit.
</p>

<p>
There's a hacky way to mimick the VM style more closely, to make it
easier to build your mental model while learning container
technology: The trick is to run <code>tail -f /dev/null</code> as your main
process. This is basically a low-consumption infinite loop. We'll
see more about that later.
</p>
</div>
</div>

<div id="outline-container-orgae2ed39" class="outline-2">
<h2 id="orgae2ed39"><span class="section-number-2">9</span> What are containers made of?</h2>
<div class="outline-text-2" id="text-9">
<p>
A container needs a few things to run.
</p>
<ul class="org-ul">
<li>filesystem. The same as you'd need a .img which is the "saved
state" that the vm runner will use as a filesystem, container
running systems need also a fake filesystem to use as its main
filesystem.</li>

<li>networking. Different containers can be running at the same time,
and you can choose to make them see each other or not. Or you can
choose to give each one an IP on the same network as the host, or
not. You can even give them the <code>--net host</code> option so that all
ports opened will live in the same host as the host machine. In
that case, if you run 1 container that opens port 3000 and another
that opens 4000, you can reach all services from all containrs, or
even the host, using <code>localhost:XXXX</code>.</li>

<li>cpu</li>
</ul>
</div>
</div>

<div id="outline-container-orgfe45bd0" class="outline-2">
<h2 id="orgfe45bd0"><span class="section-number-2">10</span> can I run 2 containers on the same filesystem?</h2>
<div class="outline-text-2" id="text-10">
<p>
you can run 2 instances of the same Image, making them 2 different
running containers, and they should be independent from one another.
</p>

<p>
Even if you modify the filesystem, one container won't see the
modification of the other, because they run "copies" of the Image
filesystem. Nothing is shared unless you specify it.
</p>
</div>
</div>

<div id="outline-container-org0a5a1c3" class="outline-2">
<h2 id="org0a5a1c3"><span class="section-number-2">11</span> patterns</h2>
<div class="outline-text-2" id="text-11">
<p>
We'll start seeing different patterns, like small exercises, and
we'll start adding them up.  It's a bit like <code>the * schemer</code> style,
only worse (because I'm not Dan).
</p>
</div>
</div>

<div id="outline-container-org55213e8" class="outline-2">
<h2 id="org55213e8"><span class="section-number-2">12</span> Build</h2>
<div class="outline-text-2" id="text-12">
<p>
<code>docker build image-directory</code> will create an image from a list of
commands in a <code>Dockerfile</code>.
</p>

<p>
Images are the filesystem of the container. Think a chroot, or think
the .img or .vdi file you download to run virtualbox on it.
</p>
</div>
</div>

<div id="outline-container-org2b29b93" class="outline-2">
<h2 id="org2b29b93"><span class="section-number-2">13</span> Dockerfile</h2>
<div class="outline-text-2" id="text-13">
<p>
A dockerfile contains the recipe to create the image and leave the
image in your desired state, ready to be run later on a container.
</p>

<p>
It's like a shellscript, with some special commands, but it's an
imperative script that gets run by <code>docker build</code>.
</p>

<p>
Q: What runs the dockerfile? in which environment?
</p>
</div>
</div>

<div id="outline-container-org89ac23b" class="outline-2">
<h2 id="org89ac23b"><span class="section-number-2">14</span> images can extend other images</h2>
<div class="outline-text-2" id="text-14">
<p>
Dockerfiles can be divided in 3 parts
</p>
<div class="org-src-container">
<pre class="src src-bash">FROM XXXYYYY     <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&lt;- 1 From</span>
.....            <span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">&lt;- 2 the rest</span>
.....
.....
.....
.....
CMD/ENTRYPOINT/RUN <span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">&lt;- run command</span>
</pre>
</div>

<p>
You usually start from an image that already has some contents in
its filesystem. That's why usually Dockerfiles start with the name
of a distro <code>FROM ubuntu:20.04</code>.  If you'd like a completely empty
filesystem to start from, there's an images called <code>scratch</code>, that
looks like a recently formatted filesystem.
</p>
</div>
</div>

<div id="outline-container-orgb0eddb1" class="outline-2">
<h2 id="orgb0eddb1"><span class="section-number-2">15</span> can I only "inherit" from an official image?</h2>
<div class="outline-text-2" id="text-15">
<p>
You can inherit from any image. Images can be in a container
registry (usually on the internet), or locally, where you have a
local collection of already downloaded images, ready to be used.
</p>

<p>
Also, when you're using <code>docker build</code>, you are creating a new
image.
</p>
</div>
</div>

<div id="outline-container-org90b4071" class="outline-2">
<h2 id="org90b4071"><span class="section-number-2">16</span> Examples?</h2>
<div class="outline-text-2" id="text-16">
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">echo</span> &lt;&lt;EOF
<span style="font-weight: bold;">  FROM ubuntu:20.04</span>
<span style="font-weight: bold;">EOF &gt;Dockerfile</span>
<span style="font-weight: bold;">docker build .</span>

<span style="font-weight: bold;">....</span>
<span style="font-weight: bold;">Successfully build 7e0aa2e69a15</span>
</pre>
</div>
<p>
At this point, 7e0aa2e69a15 is functionally exact as the
ubuntu:20.04. it's like subclassing a class without changing any
method.
</p>
</div>
</div>

<div id="outline-container-org4ab1f78" class="outline-2">
<h2 id="org4ab1f78"><span class="section-number-2">17</span> How do we know it?</h2>
<div class="outline-text-2" id="text-17">
<div class="org-src-container">
<pre class="src src-bash">diff &lt;(docker inspect 7e0aa2e69a15) &lt;(docker inspect ubuntu:20.04)
</pre>
</div>
</div>
</div>

<div id="outline-container-org700a9c8" class="outline-2">
<h2 id="org700a9c8"><span class="section-number-2">18</span> Let's play with docker inspect</h2>
<div class="outline-text-2" id="text-18">
<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold;">echo</span> &lt;&lt;EOF
<span style="font-weight: bold;">  FROM ubuntu:20.04</span>
<span style="font-weight: bold;">  CMD ["tail -f /dev/null"]</span>
<span style="font-weight: bold;">EOF &gt;Dockerfile</span>
<span style="font-weight: bold;">docker build .</span>

<span style="font-weight: bold;">....</span>
<span style="font-weight: bold;">Successfully build aabbccdd</span>
</pre>
</div>
<p>
Now, let's diff them:
</p>
<div class="org-src-container">
<pre class="src src-bash">diff &lt;(docker inspect aabbccdd) &lt;(docker inspect ubuntu:20.04)
</pre>
</div>

<p>
Now we see the differences, and they mostly make sense. I guess you
now can be confident with <code>inspect</code>. Everything should make sense.
</p>
</div>
</div>

<div id="outline-container-org40aafdc" class="outline-2">
<h2 id="org40aafdc"><span class="section-number-2">19</span> Where/how are those images stored?</h2>
<div class="outline-text-2" id="text-19">
<p>
Instead of having a .iso, .img, or .vdk, images are stored as a
directory with a bunch of data and metadata.
</p>
</div>
</div>

<div id="outline-container-orga574635" class="outline-2">
<h2 id="orga574635"><span class="section-number-2">20</span> Dockerfiles are like</h2>
<div class="outline-text-2" id="text-20">
<div class="org-src-container">
<pre class="src src-bash">git clone ubuntu:20.04 --depth=1
cmd1
git add -A; git commit -m <span style="font-style: italic;">'step1'</span>
cmd2
git add -A; git commit -m <span style="font-style: italic;">'step2'</span>
....
</pre>
</div>

<p>
If you imagine 2 dockerfiles that are equal except in the last line,
all but last lines are producing the same images. Docker is smart
enough to share them, so the "blobs" (in git parlance) are unique
(to keep the analogy working, you've got to obviate the fact that
git would create different commits because they happen on different
dates)
</p>
</div>
</div>

<div id="outline-container-org90e93f4" class="outline-2">
<h2 id="org90e93f4"><span class="section-number-2">21</span> Running a container</h2>
<div class="outline-text-2" id="text-21">
<p>
Once we have the image filesystem, we're ready to run it. When we
run a process inside that image, jailed in a docker network
(described in the <code>docker run</code> command), we are "starting" the
container.
</p>

<p>
In that moment, you can think of a last ephemeral commit in that
chain of commits. We could be modifying files there, and we would
see them, but when we stop and kill the container, that layer would
disappear.
</p>
</div>
</div>

<div id="outline-container-orge0cd257" class="outline-2">
<h2 id="orge0cd257"><span class="section-number-2">22</span> Minimal flags</h2>
<div class="outline-text-2" id="text-22">
<ul class="org-ul">
<li><code>docker run --rm -ti image command</code> . Those flags the basic
combination. <code>--rm</code> tells it to clean after itself, removing
whatever it created to make a container from <code>image</code>. <code>-ti</code> binds
an interactive terminal, so we can communicate with it. You want
that when running things locally 90% of the time.</li>

<li><code>docker run --net=host</code> . This flattens all networking of that
container to use the same ip as the host, so everything lives in
the same machine, and can get to the other via
<code>localhost</code>. Problem with it is that ports may collide. just be
aware it's a shortcut and you'll probably want to fix it at some
point.</li>

<li><code>docker run -v $PWD:/my-dir</code> mounts a directory from host to
container.</li>
</ul>
</div>
</div>

<div id="outline-container-org6eed0ab" class="outline-2">
<h2 id="org6eed0ab"><span class="section-number-2">23</span> testing images and containers</h2>
<div class="outline-text-2" id="text-23">
<p>
<code>docker run --rm -ti ubuntu:20.04 bash</code>.  This will open a bash
starting from an ubuntu:20.04 image.
</p>

<p>
In another terminal, run <code>docker run --rm -ti ubuntu:20.04 bash</code>
again.
</p>

<p>
You can see that both containers are running independently (files
created in one are not seen in the other one).
</p>

<p>
And each one of them thinks it's unique. try to run <code>top</code> in each
one of them. They shouldn't see each other.
</p>

<p>
But still, if you run <code>docker ps</code> from the host, you can see both
containers run from the same image.
</p>
</div>
</div>

<div id="outline-container-org3930ed4" class="outline-2">
<h2 id="org3930ed4"><span class="section-number-2">24</span> Running multiple commands</h2>
<div class="outline-text-2" id="text-24">
<p>
<code>docker run --rm -ti ubuntu "apt update | apt install foo"</code> doesn't
work, but if you want to run several commands at the same time from
the "run" command, To test things out from a script, you can use
</p>

<div class="org-src-container">
<pre class="src src-bash">docker run --rm -ti ubuntu bash -ci <span style="font-style: italic;">"apt update &amp;&amp; apt install net-tools"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b30f1f" class="outline-2">
<h2 id="org3b30f1f"><span class="section-number-2">25</span> Commit</h2>
<div class="outline-text-2" id="text-25">
<p>
I said that a running container has that ephemeral last layer, where
your modifications happen, and they survive a <code>stop/start</code>, but they
don't survive a kill or rm.
</p>

<p>
But there's a way to make the current state permanent, and
effectively create an image, from where new containers can be
spawned or new Dockerfiles can start FROM.
</p>

<div class="org-src-container">
<pre class="src src-bash">docker run -ti ubuntu:20.04 bash
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">inside the container</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">'hi'</span> &gt;/tmp/foo
</pre>
</div>

<p>
And in the host
</p>
<div class="org-src-container">
<pre class="src src-bash">$ docker ps
CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                                            NAMES
c6e13a79c7b3        ubuntu                      <span style="font-style: italic;">"bash"</span>                   15 seconds ago      Up 14 seconds                                                        determined_wu
$ docker commit c6e13a79c7b3
sha256:d6581aae94a58d9be27b6fecf576630fead7a05b003be12796152110d7f0b010
$ docker run --rm -ti d6581aae94a58d9be27b6fecf576630fead7a05b cat /tmp/foo
hi
</pre>
</div>

<p>
See? we created a new image, and we started a container from it
</p>
</div>
</div>

<div id="outline-container-orgf6a9697" class="outline-2">
<h2 id="orgf6a9697"><span class="section-number-2">26</span> Env vars</h2>
<div class="outline-text-2" id="text-26">
<p>
Build time <code>.env</code>, runtime <code>-e</code> .
</p>
</div>
</div>

<div id="outline-container-orgbd643ca" class="outline-2">
<h2 id="orgbd643ca"><span class="section-number-2">27</span> If I am a program running on a container, what do I see?</h2>
<div class="outline-text-2" id="text-27">
<p>
try it: We said there are mostly 3 things that get isolated: network, filesystem and processes.
</p>
</div>


<div id="outline-container-org2e2044d" class="outline-3">
<h3 id="org2e2044d"><span class="section-number-3">27.1</span> Processes</h3>
<div class="outline-text-3" id="text-27-1">
<p>
Instead of bash, you can run any other program as the main one. For
example, <code>docker run -ti --rm ubuntu top</code>.  This will run <code>top</code>,
and list all processes <code>top</code> can see. Not many, really.
</p>
</div>
</div>

<div id="outline-container-org5a3d4ff" class="outline-3">
<h3 id="org5a3d4ff"><span class="section-number-3">27.2</span> Network</h3>
<div class="outline-text-3" id="text-27-2">
<p>
Let's play with netstat. Netstat is not installd by default, so
we'll have to install it each time.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">isolated</span>
docker run --rm -ti ubuntu bash -ci <span style="font-style: italic;">"apt update &amp;&amp; apt install net-tools &amp;&amp; netstat -atunp"</span>
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">shared network</span>
docker run --net=host --rm -ti ubuntu bash -ci <span style="font-style: italic;">"apt update &amp;&amp; apt install net-tools &amp;&amp; netstat -atunp"</span>
</pre>
</div>
</div>
</div>


<div id="outline-container-org72a3b95" class="outline-3">
<h3 id="org72a3b95"><span class="section-number-3">27.3</span> filesystem</h3>
<div class="outline-text-3" id="text-27-3">
<p>
You should be able to peek through directories by mounting volumes.
</p>
<div class="org-src-container">
<pre class="src src-bash">docker run --rm -ti -v /tmp:/mything ubuntu ls /mything
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org2b37001" class="outline-2">
<h2 id="org2b37001"><span class="section-number-2">28</span> Can a container run more than one process?</h2>
<div class="outline-text-2" id="text-28">
<p>
Yes. Let's try something
</p>
<div class="org-src-container">
<pre class="src src-bash">docker run --rm -ti ubuntu bash
<span style="font-weight: bold; font-style: italic;"># </span><span style="font-weight: bold; font-style: italic;">inside the container's shell</span>
top
</pre>
</div>
<p>
There you see 2 processes, bash and top.
</p>
</div>
</div>

<div id="outline-container-org3a78c28" class="outline-2">
<h2 id="org3a78c28"><span class="section-number-2">29</span> Using cat from ubuntu container</h2>
<div class="outline-text-2" id="text-29">
<div class="org-src-container">
<pre class="src src-bash">docker run --rm ubuntu cat /etc/lsb-release
</pre>
</div>
</div>
</div>

<div id="outline-container-org3994299" class="outline-2">
<h2 id="org3994299"><span class="section-number-2">30</span> mount a file and cat it from inside</h2>
<div class="outline-text-2" id="text-30">
<div class="org-src-container">
<pre class="src src-bash">docker run --rm -v /etc/lsb-release:/etc/lsb-release ubuntu cat /etc/lsb-release
</pre>
</div>
</div>
</div>

<div id="outline-container-org0970f02" class="outline-2">
<h2 id="org0970f02"><span class="section-number-2">31</span> Docker as a tool to help you hack on development</h2>
<div class="outline-text-2" id="text-31">
<ul class="org-ul">
<li><a href="https://fly.io/blog/docker-without-docker/">https://fly.io/blog/docker-without-docker/</a>
<ul class="org-ul">
<li><a href="https://gist.github.com/tqbf/10006fae0b81d7c7c93513890ff0cf08">https://gist.github.com/tqbf/10006fae0b81d7c7c93513890ff0cf08</a></li>
</ul></li>
<li><a href="https://vsupalov.com/rebuilding-docker-image-development/">https://vsupalov.com/rebuilding-docker-image-development/</a></li>
</ul>
</div>
<div id="outline-container-orge80bf6b" class="outline-3">
<h3 id="orge80bf6b"><span class="section-number-3">31.1</span> network</h3>
<div class="outline-text-3" id="text-31-1">
<ul class="org-ul">
<li><a href="http://flaviotoffalini.info/posts/2019/07/docker-network/">http://flaviotoffalini.info/posts/2019/07/docker-network/</a></li>
<li><a href="https://www.cb-net.co.uk/devops/docker-container-network-isolation/">https://www.cb-net.co.uk/devops/docker-container-network-isolation/</a></li>
<li><a href="https://iximiuz.com/en/posts/container-networking-is-simple/">https://iximiuz.com/en/posts/container-networking-is-simple/</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org36ad0af" class="outline-2">
<h2 id="org36ad0af"><span class="section-number-2">32</span> dev</h2>
<div class="outline-text-2" id="text-32">
<ul class="org-ul">
<li><a href="https://earthly.dev/">https://earthly.dev/</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Raimon Grau</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.1.9)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
